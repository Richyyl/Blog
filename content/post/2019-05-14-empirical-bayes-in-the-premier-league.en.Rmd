---
title: Empirical bayes in the premier league
author: Rich Louden
date: '2019-05-14'
slug: empirical-bayes-in-the-premier-league
categories: []
tags: []
type: ''
subtitle: ''
image: ''
draft: True
---

Recently I've been looking at getting into Bayesian analysis, firstly through some of Richard McElreaths Statistical rethinking materials ![link](https://github.com/rmcelreath/statrethinking_winter2019) and also David Robinson's very well written book on empirical bayes analysis, which simplifies the process by both introducing and r package and using baseball for all it's examples ![link](http://varianceexplained.org/r/empirical-bayes-book/).

In an attempt to further learn some of the latter materials I thought I'd apply what is taught in the book to a sport of my own preference, ie Football. Now before someone says something, not american football, proper football, which some people may call 'soccer'.

To do this I could of gone in a variety of ways, since empirical bayes relates to to bernouli trial, ie a yes / no outcome from a single action. This would allow for tackles, passes, goals, shots on target or saves to be used for thsi analysis, for which i decided to g with passing, due to the increase in 

```{r}

library(tidyverse)
library(data.table)
library(here)
library(ebbr)
library(rvest)
library(pdftools)

theme_set(theme_minimal())

```

```{r}

season_16_17 <- list.files(path = here("2016-17", "gws"), pattern = ".csv") %>%
  map_df(~fread(., stringsAsFactors = FALSE)) %>%
  select(-25, -26, -53) %>%
  group_by(name) %>%
  summarise_if(is.numeric, sum) %>%
  select(1, contains("passes")) %>%
  select(-4)

season_17_18 <- list.files(path = here("2017-18", "gws"), pattern = ".csv") %>%
  map_df(~fread(., stringsAsFactors = FALSE)) %>%
  select(-25, -26, -53) %>%
  group_by(name) %>%
  summarise_if(is.numeric, sum) %>%
  select(1, contains("passes")) %>%
  select(-4)

season_18_19 <- list.files(path = here("2018-19", "gws"), pattern = ".csv") %>%
  map_df(~fread(., stringsAsFactors = FALSE)) %>%
  select(-25, -26, -53) %>%
  group_by(name) %>%
  summarise_if(is.numeric, sum) %>%
  select(1, contains("passes")) %>%
  select(-4)

```

```{r}

total_passes <- full_join(season_16_17, season_17_18, by = "name") %>%
  full_join(season_18_19, by = "name") %>%
  mutate_all(funs(replace(., is.na(.), 0)))

```





##### summarise total attempted and completed passes and join together

attempted_passes <- total_passes %>%
  select(1,contains("attempted")) %>%
  rowwise() %>%
  mutate(total_attempted = sum(attempted_passes.x,attempted_passes.y,
                               attempted_passes)) %>%
  select(1,5)

completed_passes <- total_passes %>%
  select(1,contains("completed")) %>%
  rowwise() %>%
  mutate(total_completed = sum(completed_passes.x,completed_passes.y,
                               completed_passes)) %>%
  select(1,5)

joined_passes <- inner_join(completed_passes, attempted_passes) %>%
  filter(total_attempted > 0) %>%
  rowwise() %>%
  mutate(passing_accuracy = total_completed / total_attempted) %>%
  arrange(desc(passing_accuracy)) %>%
  mutate(name = str_trim(name, side = "right"),
  name = str_replace(name, "_", " "))


###calculate prior and update with data to create posterior

passing_prior <- joined_passes %>%
  add_ebb_estimate(total_completed, total_attempted)


####graph up top 15 passers from the past two seasons

passing_prior %>%
  top_n(15, .fitted) %>%
  ggplot(aes(.fitted, reorder(name, .fitted))) +
  geom_point() +
  geom_errorbarh(aes(xmin = .low, xmax = .high)) +
  labs(x = "Empirical Bayes estimate (w/ 95% credible interval)",
       y = "",
       title = "Top 15 most accurate passers (2016 - 2018)")

#### who are the top 10 most consistent passers?

passing_prior %>%
  rowwise() %>%
  mutate(conf_dif = .high - .low) %>%
  arrange(conf_dif) %>%
  head(10) %>%
  ggplot(aes(.fitted, reorder(name, .fitted))) +
  geom_point() +
  geom_errorbarh(aes(xmin = .low, xmax = .high)) +
  labs(x = "Empirical Bayes estimate (w/ 95% credible interval)",
       y = "",
       title = "Top 10 most consistent passers (2016 - 2018)")


######################## investigate player positions and passing

### get position information for players

player_list <- pdf_text(here("plfpl_by_position_09_08_2018.pdf")) %>%
  as_tibble() %>%
  unnest_tokens(word, value, token = "lines") %>%
  mutate(word = str_trim(word, side = "both"),
         word = str_replace_all(word, "\\s{2,20}", "-"),
         word = str_replace_all(word, "\\s{1}", "_")) %>%
  separate(word, c("name", "club", "position", "x1", "x2", "x3", "x4"), "-") %>%
  select(1:3) %>%
  mutate(name = str_to_title(name),
         name = str_remove_all(name, "-", " "))

#### add in surnames for passing prior list

surnames_prior <- separate(passing_prior, name, c("first", "last"), " ")


positioned_prior <- surnames_prior %>%
  inner_join(player_list, by = c("last" = "name")) %>%
  filter(position %in% c("goalkeeper", "defender", "midfielder", "forward")) %>%
  group_by(position) %>%
  summarise(total_comp = sum(total_completed),
            total_att = sum(total_attempted)) %>%
  add_ebb_estimate(total_comp, total_att)

positioned_prior %>%
  ggplot(aes(.fitted, reorder(position, .fitted))) +
  geom_point() +
  geom_errorbarh(aes(xmin = .low, xmax = .high)) +
  labs(x = "Empirical Bayes estimate (w/ 95% credible interval)",
       y = "",
       title = "Passing accuracy by position")
